<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ™ºæ…§æ•‘æ´èµ°å»Šç³»çµ±</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --text:#e5e7eb; /* gray-200 */
      --accent:#22d3ee; /* cyan-400 */
      --accent2:#a78bfa; /* violet-400 */
      --card:#0b1220; /* darker */
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(120deg,var(--bg),#0b1220);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Helvetica Neue", Arial}
    .app{display:grid;grid-template-columns:380px 1fr;gap:14px;height:100dvh;padding:14px}
    @media (max-width: 960px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr;height:auto;min-height:100dvh}}
    .panel{background:linear-gradient(180deg,var(--panel),#0d1325);border:1px solid #1f2937;border-radius:18px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel h1{font-size:18px;margin:0 0 10px;letter-spacing:.3px}
    .panel .sub{color:var(--muted);font-size:13px;margin-bottom:10px}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    label{font-size:13px;color:var(--muted)}
    input, select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:var(--text);outline:none}
    input:focus, select:focus{border-color:var(--accent)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:var(--text);cursor:pointer;user-select:none}
    .btn:hover{border-color:var(--accent)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b1220;border:none}
    .btn.ghost{background:transparent;border:1px dashed #334155}
    .btn.small{padding:8px 10px;font-size:13px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .switch{display:flex;align-items:center;gap:10px}
    .switch input{width:auto}
    .mapWrap{position:relative;border-radius:18px;overflow:hidden;border:1px solid #1f2937}
    #map{width:100%;height:100%}
    .mapWrap .chips{position:absolute;top:10px;left:10px;display:flex;gap:8px;flex-wrap:wrap}
    .chip{backdrop-filter: blur(6px);background:rgba(15,23,42,.65);border:1px solid rgba(148,163,184,.25);color:#e2e8f0;padding:6px 10px;border-radius:999px;font-size:12px}
    .legend{position:absolute;bottom:10px;left:10px;background:rgba(2,6,23,.72);border:1px solid rgba(148,163,184,.25);padding:8px 10px;border-radius:12px;font-size:12px}
    .legend b{color:#fff}
    .dirPanel{background:rgba(2,6,23,.72);border-left:1px solid #1f2937;overflow:auto}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted)}
    input[type="time"]::-webkit-calendar-picker-indicator {
        filter: invert(40%) sepia(80%) saturate(500%) hue-rotate(200deg);
    }
    #back{
      background-color: transparent;
      height: 30px;
      width: 30px;
      background-size: cover; /* ä½¿åœ–ç‰‡è¦†è“‹æ•´å€‹å…ƒç´  */
      background-repeat: no-repeat; /* ä¸é‡è¤‡å¹³é‹ª */
      background-position: center; /* åœ–ç‰‡ç½®ä¸­ */
      background-image: url('previous.png');
      margin-bottom: 10px;
    }

    #chat-launcher{position:fixed;left:65px;top:29px;width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b1220;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:9999}
    #chat-panel{position:fixed;right:20px;top:84px;width:360px;max-height:70vh;background:linear-gradient(180deg,var(--panel),#0d1325);border:1px solid #1f2937;border-radius:14px;display:none;flex-direction:column;overflow:hidden;z-index:9999}
    .chat-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2937}
    .chat-title{font-size:14px}
    .chat-close{background:transparent;border:0;color:#e5e7eb;font-size:18px;cursor:pointer}
    .chat-messages{padding:12px;overflow:auto;display:flex;flex-direction:column;gap:10px;max-height:48vh}
    .msg{padding:10px 12px;border-radius:12px;max-width:82%;white-space:pre-wrap;line-height:1.4}
    .msg.user{align-self:flex-end;background  :#0b1220;border:1px solid #334155}
    .msg.bot{align-self:flex-start;background:#0f172a;border:1px solid #334155}
    .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #1f2937}
    .chat-input input{flex:1}
    .chat-input .btn{padding:8px 12px}
  </style>
</head>
<body>
  <div class="app">
    <section class="panel">
      <button onclick="window.location.href = './index.html'" class="btn" id="back"></button>
      <h1>æ™ºæ…§æ•‘æ´èµ°å»Šç³»çµ±</h1>
      <p class="sub">è¼¸å…¥èµ·é»èˆ‡ç›®çš„åœ°ï¼Œå¯è‡ªå‹•ä¼°ç®—æœ€å¿«è·¯ç·šã€‚</p>

      <form id="routeForm" class="row" onsubmit="return false;">
        <div class="row">
          <label for="origin">èµ·é»ï¼ˆOriginï¼‰</label>
          <div class="stack">
            <input id="origin" placeholder="è¼¸å…¥åœ°å€æˆ–åœ°æ¨™ï¼Œä¾‹å¦‚ï¼šå°åŒ—101" />
            <button class="btn small" id="useMyLoc" type="button">ç”¨æˆ‘çš„ä½ç½®</button>
          </div>
        </div>
        <div class="row">
          <label for="destination">ç›®çš„åœ°ï¼ˆDestinationï¼‰</label>
          <div class="stack">
            <input id="destination" placeholder="è¼¸å…¥åœ°å€æˆ–åœ°æ¨™ï¼Œä¾‹å¦‚ï¼šå°ä¸­è»Šç«™" />
            <button class="btn small" id="swapBtn" type="button">â‡„ äº¤æ›èµ·è¨–</button>
          </div>
        </div>

        <div class="row">
          <button class="btn primary" id="routeBtn" type="submit">è¦åŠƒè·¯ç·š</button>
        </div>
        <div class="row" style="margin-top: 10px;">
            <label>è™ŸèªŒä¿®æ”¹é–‹å§‹æ™‚é–“</label>
            <input type="time" id="timeInput" style="color: #e5e7eb;" placeholder="è«‹è¼¸å…¥æ‚¨çš„è™ŸèªŒä¿®æ”¹é–‹å§‹æ™‚é–“" />
            <button class="btn small" id="useMyTime" type="button">ç”¨ç¾åœ¨æ™‚é–“</button>
        </div>
        <div class="row">
            <button class="btn primary" type="button" id="edit">è™ŸèªŒä¿®æ”¹</button>
        </div>
        <div class="row">
          <label>å·²ç¶“é–‹å§‹æ™‚é–“: </label>
          <label id="timer">-- : --</label>
        </div>
        <div class="row" style="margin-top: 5px;">
          <button class="btn small" type="button" id="reset">é‡ç½®æ™‚é–“</button>
      </form>
    </section>

    <section class="mapWrap">
      <div id="map"></div>
      <div class="chips" id="chips"></div>
      <div class="legend"><b>å³æ™‚è·¯æ³åœ–ä¾‹ï¼š</b> ç¶ =é †æš¢ã€æ©˜=ç¨æ“å¡ã€ç´…=å£…å¡ã€ç´…é»‘=åš´é‡å£…å¡</div>
    </section>
  </div>

  <aside class="dirPanel panel" id="directionsPanel" style="display:none;position:fixed;right:14px;top:14px;bottom:14px;width:360px"></aside>

  <script>
    let map, trafficLayer, directionsService, directionsRenderer, originAC, destAC;
    let originLatLng = null; // å…è¨±ä»¥ LatLng ç•¶èµ·é»ï¼ˆæˆ‘çš„ä½ç½®ï¼‰

    function initMap(){
      const TAIPEI = {lat:25.033964, lng:121.564468};
      map = new google.maps.Map(document.getElementById('map'),{
        center: TAIPEI,
        zoom: 12,
        mapId: 'DEMO_TRAFFIC_NAV_001', // å¯æ–¼é›²ç«¯åœ°åœ–æ¨£å¼ç®¡ç†è¨­å®šï¼Œå¦‚ç„¡å‰‡ç„¡å¦¨
        fullscreenControl:true,
        mapTypeControl:true,
        streetViewControl:true,
      });

      trafficLayer = new google.maps.TrafficLayer();
      trafficLayer.setMap(map);

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: false,
        preserveViewport: false,
        polylineOptions: {strokeOpacity: 0.85, strokeWeight: 6},
      });
      directionsRenderer.setMap(map);

      // è‡ªå‹•å®Œæˆ
      const acOpts = { fields: ["place_id","geometry","name","formatted_address"], componentRestrictions: { country: ["tw"] } };
      originAC = new google.maps.places.Autocomplete(document.getElementById('origin'), acOpts);
      destAC   = new google.maps.places.Autocomplete(document.getElementById('destination'), acOpts);

      // å˜—è©¦ä½¿ç”¨ç€è¦½å™¨å®šä½ä»¥å¾®èª¿åœ°åœ–ä¸­å¿ƒ
      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const ll = {lat: pos.coords.latitude, lng: pos.coords.longitude};
          map.setCenter(ll); map.setZoom(14);
        });
      }

      bindUI();
    }

    function bindUI(){
      const form = document.getElementById('routeForm');
      const btnRoute = document.getElementById('routeBtn');
      const btnMyLoc = document.getElementById('useMyLoc');
      const btnSwap = document.getElementById('swapBtn');
      const btnTime = document.getElementById('useMyTime');
      const timeInput = document.getElementById('timeInput');
      const edit = document.getElementById('edit');
      const resetBtn = document.getElementById('reset');
      let timerInterval = null;

      btnMyLoc.addEventListener('click', async ()=>{
        if (!navigator.geolocation){
          alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½'); return;
        }
        navigator.geolocation.getCurrentPosition(pos=>{
          originLatLng = {lat:pos.coords.latitude, lng:pos.coords.longitude};
          document.getElementById('origin').value = 'æˆ‘çš„ä½ç½®';
          map.setCenter(originLatLng); map.setZoom(15);
          new google.maps.Marker({position:originLatLng, map, title:'æˆ‘çš„ä½ç½®'});
        }, err=>{
          alert('ç„¡æ³•å–å¾—å®šä½ï¼š'+err.message);
        }, {enableHighAccuracy:true, timeout:10000, maximumAge:0});
      });

      btnSwap.addEventListener('click', ()=>{
        const o = document.getElementById('origin');
        const d = document.getElementById('destination');
        const tmp = o.value; o.value = d.value; d.value = tmp;
        const tmpLL = originLatLng; originLatLng = null; // äº¤æ›å¾Œé‡ç½®æˆ‘çš„ä½ç½® LatLngï¼Œé¿å…æ··æ·†
      });

      edit.addEventListener('click', ()=>{
        const inputTime = timeInput.value;
        if (!inputTime) {
            alert('è«‹å…ˆè¼¸å…¥è™ŸèªŒä¿®æ”¹é–‹å§‹æ™‚é–“');
            return;
        }
        const now = new Date();
        const [inputHours, inputMinutes] = inputTime.split(':').map(Number);
        const inputDateTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), inputHours, inputMinutes);
        let diffMs = now - inputDateTime;
        if (diffMs < 0) {
            alert('è™ŸèªŒä¿®æ”¹é–‹å§‹æ™‚é–“ä¸èƒ½æ˜¯æœªä¾†çš„æ™‚é–“');
            return;
        }
        let totalDiffSeconds = 0;
        let diffMinutes = Math.floor(totalDiffSeconds / 60);
        const timerDiv = document.getElementById('timer');
        timerDiv.textContent = `${diffMinutes} : ${totalDiffSeconds} `;;

        timerInterval = setInterval(() => {
            totalDiffSeconds++;
            diffMinutes = Math.floor(totalDiffSeconds / 60);
            diffSeconds = totalDiffSeconds % 60;
            timerDiv.textContent = `${diffMinutes} : ${diffSeconds} `;
        }, 1000);
      });

      resetBtn.addEventListener('click', ()=>{
        clearInterval(timerInterval);
        const timerDiv = document.getElementById('timer');
        timerDiv.textContent = '-- : --';
      });

      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        routeNow();
      });
    
    btnTime.addEventListener('click', ()=>{
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        timeInput.value = `${hours}:${minutes}`;
    });
    }

    function routeNow(){
      const originInput = document.getElementById('origin').value.trim();
      const destInput = document.getElementById('destination').value.trim();

      if (!originInput && !originLatLng){
        alert('è«‹è¼¸å…¥èµ·é»æˆ–ä½¿ç”¨ã€Œæˆ‘çš„ä½ç½®ã€'); return;
      }
      if (!destInput){ alert('è«‹è¼¸å…¥ç›®çš„åœ°'); return; }

      // origin å¯ä»¥æ˜¯ LatLng æˆ– å­—ä¸²
      const origin = originLatLng ? originLatLng : originInput;

      const req = {
        origin,
        destination: destInput,
        travelMode: google.maps.TravelMode['DRIVING'],
        avoidHighways: false,
        avoidTolls: false,
        provideRouteAlternatives: true,
      };

        req.drivingOptions = {
          departureTime: new Date(),
          trafficModel: 'bestguess'
        };

      directionsService.route(req, (res, status)=>{
        if (status === 'OK'){
          directionsRenderer.setDirections(res);
          // é¡¯ç¤ºæœ€å„ªè·¯ç·šè³‡è¨Šæ–¼ chips
          const route = res.routes[0];
          renderChips(route);
          // å±•ç¤º step é¢æ¿
          const panel = document.getElementById('directionsPanel');
          panel.style.display = document.getElementById('showSteps').checked ? 'block' : 'none';
          if (panel.style.display === 'block') directionsRenderer.setPanel(panel);
        } else {
          console.error('Directions error:', status, res);
          alert('è·¯ç·šè¦åŠƒå¤±æ•—ï¼š'+status+ (res && res.error_message ? ('\n'+res.error_message) : ''));
        }
      });
    }

    function renderChips(route){
      const chips = document.getElementById('chips');
      chips.innerHTML = '';
      // å½™æ•´ ETA / è·é›¢ / å£…å¡ç­‰ç´š
      const leg = route.legs && route.legs[0];
      if (!leg) return;
      const items = [];
      if (leg.duration_in_traffic){
        items.push(`é ä¼°æ™‚é–“ï¼ˆå«å£…å¡ï¼‰ï¼š${leg.duration_in_traffic.text}`);
      }
      if (leg.duration){ items.push(`ç†æƒ³æ™‚é–“ï¼š${leg.duration.text}`); }
      if (leg.distance){ items.push(`è·é›¢ï¼š${leg.distance.text}`); }
      const summary = route.summary ? `ä¸»è¦é“è·¯ï¼š${route.summary}` : '';
      if (summary) items.push(summary);
      items.forEach(t=>{
        const el = document.createElement('span');
        el.className='chip'; el.textContent=t; chips.appendChild(el);
      });
    }
  </script>
  <!-- å°‡ YOUR_API_KEY æ›¿æ›ç‚ºä½ çš„é‡‘é‘°ï¼›éœ€å•Ÿç”¨ Maps JavaScript APIã€Places APIã€Directions APIã€‚ -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAuny0PTSAc2Ys84uJZLnXbGqBeB5QhfZU&libraries=places&callback=initMap" defer></script>
  <div id="chat-launcher" title="é–‹å•ŸèŠå¤©å®¤">ğŸ’¬</div>
  <div id="chat-panel">
    <div class="chat-header">
      <div class="chat-title">AIåŠ©ç†èŠå¤©å®¤</div>
      <button class="chat-close" id="chatClose">Ã—</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯ï¼ŒæŒ‰ Enter é€å‡º" />
      <button class="btn" id="chatSend">é€å‡º</button>
    </div>
  </div>

  <script>
    // ========= Gemini Chat =========
    const GEMINI_API_KEY = 'AIzaSyDhhl8EszzTUAKvMNBpXyJ2bYenuOr8GyQ'; // âš ï¸ æ”¾åœ¨å‰ç«¯æœƒè¢«çœ‹è¦‹ï¼Œè«‹åœ¨ Google Cloud å°é‡‘é‘°åš HTTP ä¾†æºèˆ‡ API é™åˆ¶ï¼Œæˆ–æ”¹ç”¨å¾Œç«¯ Proxy
    const GEMINI_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';

    const chatLauncher = document.getElementById('chat-launcher');
    const chatPanel = document.getElementById('chat-panel');
    const chatClose = document.getElementById('chatClose');
    const chatInput = document.getElementById('chatInput');
    const chatSend = document.getElementById('chatSend');
    const chatMessages = document.getElementById('chatMessages');

    // ä»¥ç°¡å–®é™£åˆ—ç¶­æŒå°è©±æ­·å² (ç¬¦åˆ Gemini contents çµæ§‹)
    const history = [];

    chatLauncher.addEventListener('click', ()=>{
      chatPanel.style.display = 'flex';
      chatInput.focus();
      if (chatMessages.childElementCount===0) addBot('å—¨ï¼æˆ‘æ˜¯AIåŠ©ç†ï¼Œæœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«å¿™çš„å—ï¼Ÿ');
    });
    chatClose.addEventListener('click', ()=> chatPanel.style.display='none');

    chatSend.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });

    function addUser(text){
      const div = document.createElement('div'); div.className='msg user'; div.textContent=text; chatMessages.appendChild(div); chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function addBot(text){
      const div = document.createElement('div'); div.className='msg bot'; div.textContent=text; chatMessages.appendChild(div); chatMessages.scrollTop = chatMessages.scrollHeight;
    }


async function sendMessage() {
  const text = chatInput.value.trim();
  if (!text) return;
  addUser(text);
  chatInput.value = '';

  const thinking = document.createElement('div');
  thinking.className = 'msg bot';
  thinking.textContent = 'æ€è€ƒä¸­â€¦';
  chatMessages.appendChild(thinking);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  const payload = {
    contents: [
      ...history,
      { role: 'user', parts: [{ text }] }
    ]
  };

  try {
    const res = await fetch(`${GEMINI_ENDPOINT}?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    const out =
      data?.candidates?.[0]?.content?.parts?.[0]?.text ||
      'ï¼ˆæ²’æœ‰å›æ‡‰å…§å®¹ï¼‰';
    thinking.remove();
    addBot(out);
    history.push({ role: 'user', parts: [{ text }] });
    history.push({ role: 'model', parts: [{ text: out }] });
  } catch (err) {
    thinking.remove();
    addBot('å‘¼å« Gemini å¤±æ•—ï¼š' + err.message);
  }
}
</script>
</body>
</html>
