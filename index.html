<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ™ºæ…§æ•‘æ´èµ°å»Šç³»çµ±</title>
  <style>
    :root{--bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --accent2:#a78bfa; --card:#0b1220; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(120deg,var(--bg),#0b1220);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Helvetica Neue", Arial}

    /* Top Nav */
    .topnav{position:sticky;top:0;z-index:1000;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:linear-gradient(180deg,var(--panel),#0d1325);border-bottom:1px solid #1f2937}
    .brand{font-weight:700;letter-spacing:.3px}
    .navlinks{display:flex;gap:8px}
    .navbtn{border:1px solid #334155;background:#0b1220;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .navbtn:hover{border-color:var(--accent)}

    /* Home layout */
    .home{display:grid;grid-template-columns:1fr 2fr;gap:14px;padding:14px}
    @media(max-width:960px){.home{grid-template-columns:1fr}}
    .panel{scrollbar-color: #334155 #0b1220; max-height: 350px; overflow-y: scroll; background:linear-gradient(180deg,var(--panel),#0d1325);border:1px solid #1f2937;border-radius:18px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h2{margin:0 0 10px;font-size:18px}

    /* Notices */
    .notice-list{display:flex;flex-direction:column;gap:10px}
    .notice{display:flex;align-items:flex-start;gap:10px;padding:10px;border-radius:12px;background:#0b1220;border:1px solid #334155}
    .notice .ico{font-size:18px;line-height:1}

    /* Table */
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse}
    th, td{padding:10px;border-bottom:1px solid #233047;text-align:left;font-size:14px}
    thead th{position:sticky;top:0;background:#0e1426}
    .status{padding:4px 8px;border-radius:999px;border:1px solid #334155}
    .status.ok{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.5);color:#bbf7d0}
    .status.warn{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.5);color:#fde68a}

    /* Original layout overrides */
    .app{display:grid;grid-template-columns:380px 1fr;gap:14px;height:100dvh;padding:14px}
    @media (max-width: 960px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr;height:auto;min-height:100dvh}}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    label{font-size:13px;color:var(--muted)}
    input, select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:var(--text);outline:none}
    input:focus, select:focus{border-color:var(--accent)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:var(--text);cursor:pointer;user-select:none}
    .btn:hover{border-color:var(--accent)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b1220;border:none}
    .btn.small{padding:8px 10px;font-size:13px}
    .mapWrap{position:relative;border-radius:18px;overflow:hidden;border:1px solid #1f2937}
    #map{width:100%;height:100%}
    .mapWrap .chips{position:absolute;top:10px;left:10px;display:flex;gap:8px;flex-wrap:wrap}
    .chip{backdrop-filter: blur(6px);background:rgba(15,23,42,.65);border:1px solid rgba(148,163,184,.25);color:#e2e8f0;padding:6px 10px;border-radius:999px;font-size:12px}
    .legend{position:absolute;bottom:10px;left:10px;background:rgba(2,6,23,.72);border:1px solid rgba(148,163,184,.25);padding:8px 10px;border-radius:12px;font-size:12px}
    .legend b{color:#fff}
    .dirPanel{background:rgba(2,6,23,.72);border-left:1px solid #1f2937;overflow:auto}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted)}
    input[type="time"]::-webkit-calendar-picker-indicator {filter: invert(40%) sepia(80%) saturate(500%) hue-rotate(200deg)}

    /* Hide original app by default; we can show it later if needed */
    #view-map{display:none}

    /* Chat widget */
    #chat-launcher{position:fixed;right:20px;bottom:20px;width:54px;height:54px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b1220;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:9999}
    #chat-panel{position:fixed;right:20px;bottom:84px;width:360px;max-height:70vh;background:linear-gradient(180deg,var(--panel),#0d1325);border:1px solid #1f2937;border-radius:14px;display:none;flex-direction:column;overflow:hidden;z-index:9999}
    .chat-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2937}
    .chat-title{font-size:14px}
    .chat-close{background:transparent;border:0;color:#e5e7eb;font-size:18px;cursor:pointer}
    .chat-messages{padding:12px;overflow:auto;display:flex;flex-direction:column;gap:10px;max-height:48vh}
    .msg{padding:10px 12px;border-radius:12px;max-width:82%;white-space:pre-wrap;line-height:1.4}
    .msg.user{align-self:flex-end;background:#0b1220;border:1px solid #334155}
    .msg.bot{align-self:flex-start;background:#0f172a;border:1px solid #334155}
    .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #1f2937}
    .chat-input input{flex:1}
    .chat-input .btn{padding:8px 12px}
  </style>
    <!-- :root{
      --bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22d3ee;--accent2:#a78bfa;
    }
    body{margin:0;background:linear-gradient(120deg,var(--bg),#0b1220);color:var(--text);font:16px/1.45 system-ui;}
    .app{display:grid;grid-template-columns:380px 1fr;gap:14px;height:100dvh;padding:14px}
    @media(max-width:960px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr;}}
    .panel{background:linear-gradient(180deg,var(--panel),#0d1325);border:1px solid #1f2937;border-radius:18px;padding:14px}
    label{font-size:13px;color:var(--muted)}
    input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:var(--text)}
    .btn{padding:10px 12px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b1220;border:none;cursor:pointer}
    .mapWrap{position:relative;border-radius:18px;overflow:hidden}
    #map{width:100%;height:100%}
    #chat-launcher{position:fixed;right:20px;bottom:20px;width:54px;height:54px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b1220;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:9999}
  #chat-panel{position:fixed;right:20px;bottom:84px;width:360px;max-height:70vh;background:linear-gradient(180deg,var(--panel),#0d1325);border:1px solid #1f2937;border-radius:14px;display:none;flex-direction:column;overflow:hidden;z-index:9999}
  .chat-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2937}
  .chat-title{font-size:14px}
  .chat-close{background:transparent;border:0;color:#e5e7eb;font-size:18px;cursor:pointer}
  .chat-messages{padding:12px;overflow:auto;display:flex;flex-direction:column;gap:10px;max-height:48vh}
  .msg{padding:10px 12px;border-radius:12px;max-width:82%;white-space:pre-wrap;line-height:1.4}
  .msg.user{align-self:flex-end;background:#0b1220;border:1px solid #334155}
  .msg.bot{align-self:flex-start;background:#0f172a;border:1px solid #334155}
  .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid #1f2937}
  .chat-input input{flex:1}
  .chat-input .btn{padding:8px 12px} -->
</style>
</head>
<body>
  <!-- Top Navigation -->
  <header class="topnav">
    <div class="brand">æ™ºæ…§æ•‘æ´èµ°å»Šç³»çµ±</div>
    <nav class="navlinks">
      <button class="navbtn" id="navHome">æ•‘ç½æ•‘æ´ç³»çµ±</button>
      <button class="navbtn" id="navChat">AIåŠ©ç†èŠå¤©</button>
    </nav>
  </header>

  <!-- HOME View -->
  <main id="view-home" class="home">
    <section class="panel">
      <h2>æœ€æ–°å…¬å‘Š</h2>
      <div class="notice-list">
        <div class="notice"><span class="ico">ğŸ“¢</span><span>ã€Œäº”æ¬Šäº”è·¯åŠäº”å·¥å…­è·¯ç­‰æ±°æ›ç®¡ç·šå·¥ç¨‹ã€è¨ˆç•«æ€§åœæ°´</span></div>
        <div class="notice"><span class="ico">ğŸ“¢</span><span>ã€ŒåœŸåŸå€åƒæ­²è·¯åŠå¿ ç¾©è·¯ç­‰æ±°æ›ç®¡ç·šå·¥ç¨‹ã€è¨ˆç•«æ€§åœæ°´</span></div>
        <div class="notice"><span class="ico">ğŸ“¢</span><span>ã€Œè˜†æ´²å€æ°‘ç”Ÿè¡—ã€ä¸­å±±ä¸€è·¯ã€é·ºæ±Ÿè¡—åŠä¿¡ç¾©è·¯å··å¼„ç­‰æ±°æ›ç®¡ç·šå·¥ç¨‹ã€è¨ˆç•«æ€§åœæ°´</span></div>
        <div class="notice"><span class="ico">ğŸ“¢</span><span>ã€ŒåœŸåŸå€å“¡æ—è¡—ç­‰æ±°æ›ç®¡ç·šå·¥ç¨‹ã€è¨ˆç•«æ€§åœæ°´</span></div>
      </div>
    </section>

    <section class="panel">
      <h2>æ•‘æ´ç‹€æ³</h2>
      <div class="table-wrap">
        <table class="rescue-table">
          <thead>
            <tr>
              <th>#</th>
              <th>å—ç†æ™‚é–“</th>
              <th>æ¡ˆé¡</th>
              <th>ç™¼ç”Ÿåœ°é»</th>
              <th>åŸ·è¡Œç‹€æ³</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>2025/11/05 ä¸‹åˆ 08:20:38</td>
              <td>æ•‘è­·</td>
              <td>è‡ºåŒ—å¸‚å—æ¸¯å€æ·é‹æ˜†é™½ç«™å‡ºå£4</td>
              <td><span class="status ok">åˆ°é”ç¾å ´</span></td>
            </tr>
            <tr>
              <td>2</td>
              <td>2025/11/05 ä¸‹åˆ 08:20:13</td>
              <td>æ•‘è­·</td>
              <td>è‡ºåŒ—å¸‚å…§æ¹–å€é€éç¶“ç·¯åº¦è½‰æ›GISåº§æ¨™</td>
              <td><span class="status warn">å·²å‡ºå‹¤</span></td>
            </tr>
            <tr>
              <td>3</td>
              <td>2025/11/05 ä¸‹åˆ 08:14:33</td>
              <td>æ•‘è­·</td>
              <td>è‡ºåŒ—å¸‚ä¸­å±±å€æ—æ£®åŒ—è·¯</td>
              <td><span class="status ok">åˆ°é”ç¾å ´</span></td>
            </tr>
            <tr>
              <td>4</td>
              <td>2025/11/05 ä¸‹åˆ 08:10:53</td>
              <td>æ•‘è­·</td>
              <td>è‡ºåŒ—å¸‚ä¸­å±±å€æ˜æ°´è·¯</td>
              <td><span class="status warn">å·²æ´¾é£</span></td>
            </tr>
            <tr>
              <td>5</td>
              <td>2025/11/11 ä¸‹åˆ 10:03:23</td>
              <td>æ•‘è­·</td>
              <td>æ–°åŒ—å¸‚åœŸåŸå€æ¸…æ°´è·¯</td>
              <td><span class="status warn">å·²æ´¾é£</span></td>
            </tr>
            <tr>
              <td>6</td>
              <td>2025/11/20 ä¸‹åˆ 06:13:23</td>
              <td>æ•‘è­·</td>
              <td>æ–°åŒ—å¸‚ä¸­å’Œå€é‡‘åŸè·¯</td>
              <td><span class="status warn">åˆ°é”ç¾å ´</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
  <div id="view-map" class="app">
    <section class="panel">
      <h1>ğŸš— Google Maps å°èˆª + å³æ™‚è»Šæµ + å‡ºç™¼æ™‚é–“</h1>
      <form id="routeForm" onsubmit="return false;">
        <label>èµ·é»</label>
        <input id="origin" placeholder="è¼¸å…¥èµ·é»æˆ–ç”¨æˆ‘çš„ä½ç½®" />
        <label>ç›®çš„åœ°</label>
        <input id="destination" placeholder="è¼¸å…¥ç›®çš„åœ°" />
        <label>äº¤é€šæ–¹å¼</label>
        <select id="mode">
          <option value="DRIVING">é–‹è»Š</option>
          <option value="TRANSIT">å¤§çœ¾é‹è¼¸</option>
          <option value="WALKING">æ­¥è¡Œ</option>
        </select>
        <label>å‡ºç™¼æ™‚é–“</label>
        <input type="time" id="departureTime" />
        <label><input type="checkbox" id="toggleTraffic" checked /> é¡¯ç¤ºå³æ™‚è»Šæµ</label>
        <button class="btn" id="routeBtn">è¦åŠƒè·¯ç·š</button>
      </form>
    </section>
    <section class="mapWrap"><div id="map"></div></section>
  </div>
  <script>
    let map, trafficLayer, directionsService, directionsRenderer;
    function initMap(){
      map=new google.maps.Map(document.getElementById('map'),{center:{lat:25.033964,lng:121.564468},zoom:12});
      trafficLayer=new google.maps.TrafficLayer();trafficLayer.setMap(map);
      directionsService=new google.maps.DirectionsService();
      directionsRenderer=new google.maps.DirectionsRenderer();
      directionsRenderer.setMap(map);
      document.getElementById('routeBtn').addEventListener('click',routeNow);
      document.getElementById('toggleTraffic').addEventListener('change',e=>trafficLayer.setMap(e.target.checked?map:null));
    }
    function routeNow(){
      const origin=document.getElementById('origin').value;
      const destination=document.getElementById('destination').value;
      const mode=document.getElementById('mode').value;
      const timeInput=document.getElementById('departureTime').value;
      let depTime=new Date();
      if(timeInput){
        const [h,m]=timeInput.split(':');
        depTime.setHours(h,m,0,0);
      }
      directionsService.route({
        origin,destination,travelMode:google.maps.TravelMode[mode],
        drivingOptions:{departureTime:depTime,trafficModel:'bestguess'}
      },(res,status)=>{
        if(status==='OK')directionsRenderer.setDirections(res);
        else alert('è·¯ç·šè¦åŠƒå¤±æ•—:'+status);
      });
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAuny0PTSAc2Ys84uJZLnXbGqBeB5QhfZU&callback=initMap" defer></script>
  
  <!-- Gemini Chat Widget -->
  <div id="chat-launcher" title="é–‹å•ŸèŠå¤©å®¤">ğŸ’¬</div>
  <div id="chat-panel">
    <div class="chat-header">
      <div class="chat-title">AIåŠ©ç†èŠå¤©å®¤</div>
      <button class="chat-close" id="chatClose">Ã—</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯ï¼ŒæŒ‰ Enter é€å‡º" />
      <button class="btn" id="chatSend">é€å‡º</button>
    </div>
  </div>

  <script>
    // ========= Gemini Chat =========
    const GEMINI_API_KEY = 'AIzaSyDhhl8EszzTUAKvMNBpXyJ2bYenuOr8GyQ'; // âš ï¸ æ”¾åœ¨å‰ç«¯æœƒè¢«çœ‹è¦‹ï¼Œè«‹åœ¨ Google Cloud å°é‡‘é‘°åš HTTP ä¾†æºèˆ‡ API é™åˆ¶ï¼Œæˆ–æ”¹ç”¨å¾Œç«¯ Proxy
    const GEMINI_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';

    const chatLauncher = document.getElementById('chat-launcher');
    const chatPanel = document.getElementById('chat-panel');
    const chatClose = document.getElementById('chatClose');
    const chatInput = document.getElementById('chatInput');
    const chatSend = document.getElementById('chatSend');
    const chatMessages = document.getElementById('chatMessages');

    // ä»¥ç°¡å–®é™£åˆ—ç¶­æŒå°è©±æ­·å² (ç¬¦åˆ Gemini contents çµæ§‹)
    const history = [];

    chatLauncher.addEventListener('click', ()=>{
      chatPanel.style.display = 'flex';
      chatInput.focus();
      if (chatMessages.childElementCount===0) addBot('å—¨ï¼æˆ‘æ˜¯AIåŠ©ç†ï¼Œæœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«å¿™çš„å—ï¼Ÿ');
    });
    chatClose.addEventListener('click', ()=> chatPanel.style.display='none');

    chatSend.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });

    function addUser(text){
      const div = document.createElement('div'); div.className='msg user'; div.textContent=text; chatMessages.appendChild(div); chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function addBot(text){
      const div = document.createElement('div'); div.className='msg bot'; div.textContent=text; chatMessages.appendChild(div); chatMessages.scrollTop = chatMessages.scrollHeight;
    }


async function sendMessage() {
  const text = chatInput.value.trim();
  if (!text) return;
  addUser(text);
  chatInput.value = '';

  const thinking = document.createElement('div');
  thinking.className = 'msg bot';
  thinking.textContent = 'æ€è€ƒä¸­â€¦';
  chatMessages.appendChild(thinking);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  const payload = {
    contents: [
      ...history,
      { role: 'user', parts: [{ text }] }
    ]
  };

  try {
    const res = await fetch(`${GEMINI_ENDPOINT}?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    const out =
      data?.candidates?.[0]?.content?.parts?.[0]?.text ||
      'ï¼ˆæ²’æœ‰å›æ‡‰å…§å®¹ï¼‰';
    thinking.remove();
    addBot(out);
    history.push({ role: 'user', parts: [{ text }] });
    history.push({ role: 'model', parts: [{ text: out }] });
  } catch (err) {
    thinking.remove();
    addBot('å‘¼å« Gemini å¤±æ•—ï¼š' + err.message);
  }
}

  </script>

  <script>
    // ===== Nav interactions =====
    const navHome = document.getElementById('navHome');
    const navChat = document.getElementById('navChat');
    const viewHome = document.getElementById('view-home');
    const viewMap = document.getElementById('view-map');

    navHome?.addEventListener('click', ()=>{
        window.location.href='nav.html';
      viewHome.style.display='grid';
      viewMap.style.display='none';
      window.scrollTo({top:0,behavior:'smooth'});
    });
    navChat?.addEventListener('click', ()=>{
      document.getElementById('chat-panel').style.display='flex';
      document.getElementById('chatInput').focus();
    });

  </script>
</body>
</html>
