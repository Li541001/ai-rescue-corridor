<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Google Maps 導航 + 即時車流 Demo</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --text:#e5e7eb; /* gray-200 */
      --accent:#22d3ee; /* cyan-400 */
      --accent2:#a78bfa; /* violet-400 */
      --card:#0b1220; /* darker */
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(120deg,var(--bg),#0b1220);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Helvetica Neue", Arial}
    .app{display:grid;grid-template-columns:380px 1fr;gap:14px;height:100dvh;padding:14px}
    @media (max-width: 960px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr;height:auto;min-height:100dvh}}
    .panel{background:linear-gradient(180deg,var(--panel),#0d1325);border:1px solid #1f2937;border-radius:18px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel h1{font-size:18px;margin:0 0 10px;letter-spacing:.3px}
    .panel .sub{color:var(--muted);font-size:13px;margin-bottom:10px}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    label{font-size:13px;color:var(--muted)}
    input, select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:var(--text);outline:none}
    input:focus, select:focus{border-color:var(--accent)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:var(--text);cursor:pointer;user-select:none}
    .btn:hover{border-color:var(--accent)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b1220;border:none}
    .btn.ghost{background:transparent;border:1px dashed #334155}
    .btn.small{padding:8px 10px;font-size:13px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .switch{display:flex;align-items:center;gap:10px}
    .switch input{width:auto}
    .mapWrap{position:relative;border-radius:18px;overflow:hidden;border:1px solid #1f2937}
    #map{width:100%;height:100%}
    .mapWrap .chips{position:absolute;top:10px;left:10px;display:flex;gap:8px;flex-wrap:wrap}
    .chip{backdrop-filter: blur(6px);background:rgba(15,23,42,.65);border:1px solid rgba(148,163,184,.25);color:#e2e8f0;padding:6px 10px;border-radius:999px;font-size:12px}
    .legend{position:absolute;bottom:10px;left:10px;background:rgba(2,6,23,.72);border:1px solid rgba(148,163,184,.25);padding:8px 10px;border-radius:12px;font-size:12px}
    .legend b{color:#fff}
    .dirPanel{background:rgba(2,6,23,.72);border-left:1px solid #1f2937;overflow:auto}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted)}
    input[type="time"]::-webkit-calendar-picker-indicator {
        filter: invert(40%) sepia(80%) saturate(500%) hue-rotate(200deg);
    }
  </style>
</head>
<body>
  <div class="app">
    <section class="panel">
      <h1>智慧救援走廊系統</h1>
      <p class="sub">輸入起點與目的地，可自動估算最快路線。</p>

      <form id="routeForm" class="row" onsubmit="return false;">
        <div class="row">
          <label for="origin">起點（Origin）</label>
          <div class="stack">
            <input id="origin" placeholder="輸入地址或地標，例如：台北101" />
            <button class="btn small" id="useMyLoc" type="button">用我的位置</button>
          </div>
        </div>
        <div class="row">
          <label for="destination">目的地（Destination）</label>
          <div class="stack">
            <input id="destination" placeholder="輸入地址或地標，例如：台中車站" />
            <button class="btn small" id="swapBtn" type="button">⇄ 交換起訖</button>
          </div>
        </div>

        <!-- <div class="grid2">
          <div>
            <label for="mode">交通方式</label>
            <select id="mode">
              <option value="DRIVING">開車</option>
              <option value="TRANSIT">大眾運輸</option>
              <option value="WALKING">步行</option>
              <option value="BICYCLING">自行車</option>
            </select>
          </div>
          <div>
            <label for="trafficModel">交通模型（開車）</label>
            <select id="trafficModel">
              <option value="bestguess">Best Guess（建議）</option>
              <option value="optimistic">Optimistic</option>
              <option value="pessimistic">Pessimistic</option>
            </select>
          </div>
        </div> -->

        <!-- <div class="grid2">
          <label class="switch"><input type="checkbox" id="avoidTolls" /> 避免收費</label>
          <label class="switch"><input type="checkbox" id="avoidHighways" /> 避免高速公路</label>
        </div> -->

        <!-- <div class="grid2">
          <label class="switch"><input type="checkbox" id="toggleTraffic" checked /> 顯示即時路況</label>
          <label class="switch"><input type="checkbox" id="showSteps" checked /> 顯示逐步導航文字</label>
        </div> -->

        <div class="row">
          <button class="btn primary" id="routeBtn" type="submit">規劃路線</button>
          <!-- <span class="hint">提示：開車模式會使用 <b>departureTime = 現在</b> 以取得交通壅塞影響的預估時間。</span> -->
        </div>
        <div class="row" style="margin-top: 10px;">
            <label>號誌修改開始時間</label>
            <input type="time" id="timeInput" style="color: #e5e7eb;" placeholder="請輸入您的號誌修改開始時間" />
            <button class="btn small" id="useMyTime" type="button">用現在時間</button>
        </div>
        <div class="row">
            <button class="btn primary">號誌修改</button>
        </div>
      </form>
    </section>

    <section class="mapWrap">
      <div id="map"></div>
      <div class="chips" id="chips"></div>
      <div class="legend"><b>即時路況圖例：</b> 綠=順暢、橘=稍擁塞、紅=壅塞、紅黑=嚴重壅塞</div>
    </section>
  </div>

  <aside class="dirPanel panel" id="directionsPanel" style="display:none;position:fixed;right:14px;top:14px;bottom:14px;width:360px"></aside>

  <script>
    let map, trafficLayer, directionsService, directionsRenderer, originAC, destAC;
    let originLatLng = null; // 允許以 LatLng 當起點（我的位置）

    function initMap(){
      const TAIPEI = {lat:25.033964, lng:121.564468};
      map = new google.maps.Map(document.getElementById('map'),{
        center: TAIPEI,
        zoom: 12,
        mapId: 'DEMO_TRAFFIC_NAV_001', // 可於雲端地圖樣式管理設定，如無則無妨
        fullscreenControl:true,
        mapTypeControl:true,
        streetViewControl:true,
      });

      trafficLayer = new google.maps.TrafficLayer();
      trafficLayer.setMap(map);

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: false,
        preserveViewport: false,
        polylineOptions: {strokeOpacity: 0.85, strokeWeight: 6},
      });
      directionsRenderer.setMap(map);

      // 自動完成
      const acOpts = { fields: ["place_id","geometry","name","formatted_address"], componentRestrictions: { country: ["tw"] } };
      originAC = new google.maps.places.Autocomplete(document.getElementById('origin'), acOpts);
      destAC   = new google.maps.places.Autocomplete(document.getElementById('destination'), acOpts);

      // 嘗試使用瀏覽器定位以微調地圖中心
      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const ll = {lat: pos.coords.latitude, lng: pos.coords.longitude};
          map.setCenter(ll); map.setZoom(14);
        });
      }

      bindUI();
    }

    function bindUI(){
      const form = document.getElementById('routeForm');
      const btnRoute = document.getElementById('routeBtn');
      const btnMyLoc = document.getElementById('useMyLoc');
      const btnSwap = document.getElementById('swapBtn');
    //   const toggleTraffic = document.getElementById('toggleTraffic');
    //   const showSteps = document.getElementById('showSteps');
      const btnTime = document.getElementById('useMyTime');
      const timeInput = document.getElementById('timeInput');

      btnMyLoc.addEventListener('click', async ()=>{
        if (!navigator.geolocation){
          alert('此瀏覽器不支援地理定位'); return;
        }
        navigator.geolocation.getCurrentPosition(pos=>{
          originLatLng = {lat:pos.coords.latitude, lng:pos.coords.longitude};
          document.getElementById('origin').value = '我的位置';
          map.setCenter(originLatLng); map.setZoom(15);
          new google.maps.Marker({position:originLatLng, map, title:'我的位置'});
        }, err=>{
          alert('無法取得定位：'+err.message);
        }, {enableHighAccuracy:true, timeout:10000, maximumAge:0});
      });

      btnSwap.addEventListener('click', ()=>{
        const o = document.getElementById('origin');
        const d = document.getElementById('destination');
        const tmp = o.value; o.value = d.value; d.value = tmp;
        const tmpLL = originLatLng; originLatLng = null; // 交換後重置我的位置 LatLng，避免混淆
      });

    //   toggleTraffic.addEventListener('change', (e)=>{
    //     trafficLayer.setMap(e.target.checked ? map : null);
    //   });

    //   showSteps.addEventListener('change', (e)=>{
    //     const panel = document.getElementById('directionsPanel');
    //     if (e.target.checked){ panel.style.display='block'; directionsRenderer.setPanel(panel); }
    //     else { directionsRenderer.setPanel(null); panel.style.display='none'; }
    //   });

      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        routeNow();
      });
    
    btnTime.addEventListener('click', ()=>{
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        timeInput.value = `${hours}:${minutes}`;
    });
    }

    function routeNow(){
      const originInput = document.getElementById('origin').value.trim();
      const destInput = document.getElementById('destination').value.trim();
    //   const mode = document.getElementById('mode').value;
    //   const avoidTolls = document.getElementById('avoidTolls').checked;
    //   const avoidHighways = document.getElementById('avoidHighways').checked;
    //   const trafficModel = document.getElementById('trafficModel').value;

      if (!originInput && !originLatLng){
        alert('請輸入起點或使用「我的位置」'); return;
      }
      if (!destInput){ alert('請輸入目的地'); return; }

      // origin 可以是 LatLng 或 字串
      const origin = originLatLng ? originLatLng : originInput;

      const req = {
        origin,
        destination: destInput,
        travelMode: google.maps.TravelMode['DRIVING'],
        avoidHighways: false,
        avoidTolls: false,
        provideRouteAlternatives: true,
      };

    //   if (mode === 'DRIVING'){
        req.drivingOptions = {
          departureTime: new Date(),
          trafficModel: 'bestguess'
        };
    //   }

      directionsService.route(req, (res, status)=>{
        if (status === 'OK'){
          directionsRenderer.setDirections(res);
          // 顯示最優路線資訊於 chips
          const route = res.routes[0];
          renderChips(route);
          // 展示 step 面板
          const panel = document.getElementById('directionsPanel');
          panel.style.display = document.getElementById('showSteps').checked ? 'block' : 'none';
          if (panel.style.display === 'block') directionsRenderer.setPanel(panel);
        } else {
          console.error('Directions error:', status, res);
          alert('路線規劃失敗：'+status+ (res && res.error_message ? ('\n'+res.error_message) : ''));
        }
      });
    }

    function renderChips(route){
      const chips = document.getElementById('chips');
      chips.innerHTML = '';
      // 彙整 ETA / 距離 / 壅塞等級
      const leg = route.legs && route.legs[0];
      if (!leg) return;
      const items = [];
      if (leg.duration_in_traffic){
        items.push(`預估時間（含壅塞）：${leg.duration_in_traffic.text}`);
      }
      if (leg.duration){ items.push(`理想時間：${leg.duration.text}`); }
      if (leg.distance){ items.push(`距離：${leg.distance.text}`); }
      const summary = route.summary ? `主要道路：${route.summary}` : '';
      if (summary) items.push(summary);
      items.forEach(t=>{
        const el = document.createElement('span');
        el.className='chip'; el.textContent=t; chips.appendChild(el);
      });
    }
  </script>
  <!-- 將 YOUR_API_KEY 替換為你的金鑰；需啟用 Maps JavaScript API、Places API、Directions API。 -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAuny0PTSAc2Ys84uJZLnXbGqBeB5QhfZU&libraries=places&callback=initMap" defer></script>
</body>
</html>
